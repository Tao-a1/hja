<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Aria2 下载中心</title>
    <link rel="stylesheet" href="/ariang/css/bootstrap-3.4.1.min.css">
    <style>
        body { padding-top: 20px; background-color: #f8f8f8; }
        .control-panel { background: white; padding: 20px; border-bottom: 1px solid #ddd; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* Toggle Switch CSS */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; vertical-align: middle; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; -webkit-transition: .4s; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; -webkit-transition: .4s; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #5cb85c; }
        input:focus + .slider { box-shadow: 0 0 1px #5cb85c; }
        input:checked + .slider:before { -webkit-transform: translateX(24px); -ms-transform: translateX(24px); transform: translateX(24px); }
        
        .status-label { font-weight: bold; margin-right: 5px; vertical-align: middle; }
        iframe { width: 100%; height: calc(100vh - 200px); border: none; }
        .form-group { margin-right: 15px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="control-panel">
        <div class="row">
            <div class="col-md-4">
                <div style="display: flex; align-items: center; height: 34px;">
                    <span class="status-label">Aria2 后台服务:</span>
                    <label class="switch">
                        <input type="checkbox" id="server-switch" onchange="toggleServer()">
                        <span class="slider round"></span>
                    </label>
                    <span id="status-text" style="margin-left: 10px; color: #666; font-size: 12px;">检测中...</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-inline">
                    <div class="form-group">
                        <label>最大同时任务数: </label>
                        <input type="number" id="max-downloads" class="form-control input-sm" style="width: 70px;" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>单文件线程数: </label>
                        <input type="number" id="split" class="form-control input-sm" style="width: 70px;" value="5" min="1" max="16">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="applyConfig()">应用设置</button>
                </div>
            </div>
            <div class="col-md-2 text-right">
                <a href="/" class="btn btn-link">返回文件列表</a>
            </div>
        </div>
    </div>
    
    <div id="service-stopped-msg" style="display: none; text-align: center; padding: 50px; background: white; border: 1px solid #ddd;">
        <h3 style="color: #777;">服务已停止</h3>
        <p>请点击上方的开关启动 Aria2 下载服务。</p>
    </div>
    <iframe id="ariang-frame"></iframe>
</div>

<script src="/ariang/js/jquery-3.3.1.min.js"></script>
<script>
    const API_BASE = '/control';
    let isInternalUpdate = false; // Prevent onchange loop

    // Set AriaNg connection settings dynamically
    function initAriaNg() {
        const protocol = window.location.protocol.replace(':', ''); 
        const host = window.location.hostname;
        const port = window.location.port || (protocol === 'https' ? '443' : '80');
        const rpcPath = 'jsonrpc';
        const secret = 'GeminiSecretToken';
        
        const src = `/ariang/index.html#!/settings/rpc/set/${protocol}/${host}/${port}/${rpcPath}/${btoa(secret)}`;
        document.getElementById('ariang-frame').src = src;
    }

    function refreshStatus() {
        $.get(API_BASE + '/status', function(data) {
            isInternalUpdate = true;
            const switchEl = $('#server-switch');
            const statusText = $('#status-text');
            const iframe = $('#ariang-frame');
            const stopMsg = $('#service-stopped-msg');
            
            if (data.running) {
                switchEl.prop('checked', true);
                statusText.text("运行中 - 随时等待命令").css('color', '#5cb85c');
                iframe.show();
                stopMsg.hide();
            } else {
                switchEl.prop('checked', false);
                statusText.text("已停止").css('color', '#d9534f');
                iframe.hide();
                stopMsg.show();
            }
            
            // Sync inputs if user is not typing
            if (!$("#max-downloads").is(":focus")) {
                $('#max-downloads').val(data.max_concurrent_downloads);
            }
            if (!$("#split").is(":focus")) {
                $('#split').val(data.split);
            }
            isInternalUpdate = false;
        });
    }

    function toggleServer() {
        if (isInternalUpdate) return;

        const switchEl = $('#server-switch');
        const isChecked = switchEl.prop('checked');
        const statusText = $('#status-text');

        // Optimistic UI update
        statusText.text(isChecked ? "正在启动..." : "正在停止...");

        if (isChecked) {
            // Turning ON: Apply current config and start
            applyConfig(true); 
        } else {
            // Turning OFF
            $.post(API_BASE + '/stop', function() { 
                // Delay refresh to allow process to exit fully
                setTimeout(refreshStatus, 1500); 
            });
        }
    }

    function applyConfig(silent = false) {
        const maxDownloads = $('#max-downloads').val();
        const split = $('#split').val();
        
        $.post(API_BASE + '/configure', JSON.stringify({
            max_concurrent_downloads: maxDownloads,
            split: split
        }), function() {
            if (!silent) alert("设置已应用，服务已启动/重启");
            refreshStatus();
            // Reload AriaNg to reconnect
            document.getElementById('ariang-frame').contentWindow.location.reload();
        });
    }

    initAriaNg();
    refreshStatus();
    setInterval(refreshStatus, 5000);
</script>
</body>
</html>
