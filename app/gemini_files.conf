server {
    listen 8082;
    server_name _;

    # 强制字符集，解决中文乱码
    charset utf-8;

    # SSL 配置 (已停用)
    # ssl_certificate /etc/nginx/ssl/gemini.crt;
    # ssl_certificate_key /etc/nginx/ssl/gemini.key;
    # ...

    root /gemini;
    client_max_body_size 10G;

    location / {
        # === 使用 Fancy Index 替代 Autoindex ===
        fancyindex on;
        fancyindex_exact_size off; # 显示人类可读大小 (KB, MB)
        fancyindex_localtime on;   # 使用服务器本地时间
        fancyindex_time_format "%Y年%m月%d日 %H:%M"; # 中文时间格式
        
        # 引入自定义的头部和底部
        fancyindex_header "/app/fancyindex_header.html";
        fancyindex_footer "/app/fancyindex_footer.html";
        
        # 忽略项目文件目录和系统文件
        fancyindex_ignore "app" "nginx_gemini.conf" "nginx_gemini_http.conf" "gemini-installer" "aria2_config" "aria2_controller.py";

        # === WebDAV 配置 (保持不变) ===
        dav_methods PUT DELETE MKCOL COPY MOVE;
        dav_ext_methods PROPFIND OPTIONS;
        create_full_put_path on;
        dav_access user:rw group:rw all:rw;

        # CORS
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, MKCOL, COPY, MOVE' always;
        add_header 'Access-Control-Allow-Headers' 'User-Agent,Keep-Alive,Content-Type' always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Dashboard 页面
    location = /dashboard.html {
        alias /gemini/app/dashboard.html;
    }

    # Upload 页面
    location = /upload.html {
        alias /gemini/app/upload.html;
    }

    # AriaNg 前端
    location /ariang/ {
        alias /gemini/app/ariang/;
        index index.html;
    }

    # Aria2 RPC 代理
    location /jsonrpc {
        proxy_pass http://127.0.0.1:6800/jsonrpc;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 控制 API 代理
    location /control/ {
        proxy_pass http://127.0.0.1:8085/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
