<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传 - Gemini 文件服务器</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; line-height: 1.5; }
        h1 { border-bottom: 1px solid #eaeaea; padding-bottom: 1rem; }
        .upload-box { border: 2px dashed #ccc; padding: 2rem; text-align: center; border-radius: 8px; margin-top: 2rem; transition: border-color 0.3s; }
        .upload-box:hover { border-color: #0070f3; }
        .btn { background: #0070f3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-top: 1rem; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        /* 进度条样式 */
        .progress-container { margin-top: 1.5rem; display: none; }
        progress { width: 100%; height: 20px; border-radius: 10px; }
        .progress-text { font-size: 0.9rem; color: #666; margin-top: 0.5rem; display: block; }
        
        #status { margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>文件上传</h1>
    <p>文件将上传到服务器的 <code>/gemini</code> 目录。</p>
    
    <div class="upload-box">
        <input type="file" id="fileInput" style="margin-bottom: 1rem;">
        <br>
        <button onclick="uploadFile()" class="btn" id="uploadBtn">开始上传</button>
        
        <div class="progress-container" id="progressContainer">
            <progress id="progressBar" value="0" max="100"></progress>
            <span class="progress-text" id="progressText">0%</span>
        </div>
    </div>

    <div id="status"></div>

    <p style="margin-top: 2rem;"><a href="/">← 返回文件列表</a></p>

    <script>
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            if (!file) {
                alert('请先选择一个文件');
                return;
            }

            // 重置 UI
            btn.disabled = true;
            statusDiv.style.display = 'none';
            statusDiv.className = '';
            progressContainer.style.display = 'block';
            progressBar.value = 0;
            progressText.textContent = '0%';

            // 创建 XMLHttpRequest 对象
            const xhr = new XMLHttpRequest();
            // 使用标准编码，Nginx 会自动解码并以 UTF-8 存储
            const targetUrl = '/' + encodeURIComponent(file.name);

            // 监听上传进度
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    progressBar.value = percentComplete;
                    progressText.textContent = percentComplete + '%';
                }
            };

            // 监听上传完成
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    statusDiv.className = 'success';
                    statusDiv.textContent = '✅ 上传成功！文件已保存。';
                    statusDiv.style.display = 'block';
                    fileInput.value = ''; // 清空选择
                    
                    // 3秒后隐藏进度条
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                } else {
                    statusDiv.className = 'error';
                    statusDiv.textContent = `❌ 上传失败 (状态码: ${xhr.status})`;
                    statusDiv.style.display = 'block';
                }
                btn.disabled = false;
            };

            // 监听错误
            xhr.onerror = function() {
                statusDiv.className = 'error';
                statusDiv.textContent = '❌ 网络错误，上传失败。';
                statusDiv.style.display = 'block';
                btn.disabled = false;
            };

            // 发送请求
            xhr.open('PUT', targetUrl, true);
            xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
            xhr.send(file);
        }
    </script>
</body>
</html>